const fs = require('fs');
const path = require('path');

// 실제 Wowhead 설명이 있는 스킬 ID 목록 (update-all-skill-descriptions.js에서 가져옴)
const validSkillIds = [
  "17", "100", "1464", "1680", "1715", "2565", "5246", "5308", "6343", "6544", "6552", "6673", "7384", "12294", "18499", "20252", "23881", "23920", "23922", "34428", "46968", "57755", "85288", "97462", "100130", "107574", "118038", "163201", "167105", "184367", "190456", "202168", "227847", "260708", "262161", "280735", "307865", "316825", "376079", "383762", "384318", "385954", "386071", "392966", "401150",
  "633", "642", "853", "1022", "1044", "2812", "19750", "20271", "20473", "24275", "25780", "26573", "31842", "31850", "31884", "31935", "32223", "35395", "53385", "53595", "53600", "62124", "82326", "85222", "85256", "85673", "86659", "96231", "105809", "114158", "114165", "115750", "148039", "152262", "183218", "184575", "184662", "190784", "200652", "200656", "204018", "204019", "204035", "205191", "205228", "210191", "210256", "212056", "213644", "213652", "214202", "215652", "215661", "216331", "223306", "231895", "255937", "267798", "271580", "271581", "275773", "275779", "304971", "310454", "316958", "317020", "317906", "326011", "326730", "327193", "337247", "343527", "343721", "375576", "378974", "378279", "383328", "384027", "384052", "385126", "387174", "387178", "387184", "388007", "388010", "388011", "388013", "389539", "391054", "392912", "392938", "403695", "403876", "404139", "404542", "405790", "406158", "407480", "408385", "408406",
  "781", "883", "982", "1130", "1495", "1513", "1543", "2641", "2643", "2649", "3045", "3355", "5116", "5384", "13165", "13809", "13813", "16827", "17253", "19263", "19386", "19434", "19574", "19577", "19801", "20736", "24394", "25294", "25295", "26064", "34026", "34477", "34490", "34600", "35079", "49045", "49050", "49052", "49067", "51753", "53209", "53271", "53351", "53478", "53480", "56641", "60192", "61044", "61684", "61685", "77767", "82939", "82941", "82948", "90361", "109248", "109259", "109304", "109491", "115939", "117526", "120360", "120679", "120964", "121818", "125050", "126216", "130392", "131894", "134477", "135299", "136634", "147362", "147363", "162488", "162530", "162537", "164273", "170323", "170324", "185358", "185743", "185791", "185855", "186254", "186257", "186258", "186270", "186387", "187650", "187651", "187698", "187707", "187708", "190925", "190928", "191241", "193455", "193526", "193530", "193532", "193533", "194277", "194279", "194291", "194306", "194386", "194397", "194407", "194509", "194594", "194595", "194599",
  "408", "703", "921", "1066", "1330", "1725", "1752", "1766", "1776", "1784", "1833", "1856", "1943", "1966", "2070", "2094", "2098", "2823", "2983", "3409", "5171", "5277", "5938", "6770", "8122", "8676", "8679", "8680", "11327", "13750", "13877", "14062", "14177", "14183", "14185", "14190", "14251", "14278", "16511", "26679", "26889", "31209", "31220", "31224", "31230", "32645", "35546", "36554", "48721", "51667", "51690", "51713", "51723", "53901", "57934", "73651", "74001", "74002", "76577", "76803", "77758", "78674", "78675", "84601", "84615", "84617", "91021", "91023", "108208", "108209", "108210", "108211", "108212", "108215", "108216",
  "139", "453", "527", "528", "585", "586", "588", "589", "594", "596", "605", "1706", "2006", "2050", "2060", "2061", "2096", "2652", "2944", "8092", "9484", "10060", "14914", "14915", "15286", "15407", "15473", "15487", "17194", "19236", "20711", "21562", "25218", "25367", "25368", "27683", "27813", "27827", "32375", "32379", "32546", "33076", "33206", "33215", "34433", "34650", "34861", "34863", "34864", "34865", "34866", "34914", "34916", "34917", "34919", "47515", "47517", "47536", "47540", "47585", "47666", "47750", "47755", "47757", "47758", "47788", "48045", "48066", "48068", "48071", "48072", "48073", "48078", "48087", "48089", "48111", "48113", "48120", "48123", "48125", "48126", "48127", "48135", "48153", "48156", "48158", "48160", "48161", "48162", "48168", "48169", "48170", "48171", "48172", "48173", "48174", "48175", "48176", "48300", "48301", "53007", "62618", "64843", "64844", "64901", "64904", "70772", "71339", "72125", "73325", "73413", "73510", "74434", "77485", "77486", "77487", "77488", "77489", "77613", "77614", "78202", "78203", "81206", "81207", "81208", "81209", "81700", "81749", "81751", "81782", "87151", "87152", "87153", "87160", "87190", "87192", "87193", "87336", "88625", "88682", "88683", "88684", "88685", "88686", "88687", "89485", "89488",
  "43265", "45524", "45529", "46584", "47476", "47528", "47541", "48263", "48265", "48266", "48707", "48721", "48743", "48792", "49016", "49020", "49028", "49039", "49143", "49184", "49206", "49222", "49576", "49998", "50842", "51052", "51124", "51271", "51462", "55050", "55090", "55095", "55233", "56222", "56815", "57330", "59921", "61999", "63560", "66188", "66196", "66198", "66990", "67799", "70654", "73975", "77575", "77606", "81136", "81141", "81164", "81229", "81237", "81256", "108194", "108196", "108199", "108200", "108201", "110959", "111673", "114556", "114851", "114866", "115098", "115635", "115989", "115994", "116011", "116888", "117737", "123693", "123698", "130735", "130736",
  "192", "324", "421", "546", "556", "974", "1064", "1535", "2008", "2050", "2062", "2484", "2645", "2825", "2894", "3599", "5394", "5675", "5730", "6196", "8004", "8012", "8024", "8027", "8033", "8042", "8050", "8056", "8143", "8170", "8177", "8184", "8190", "8227", "8232", "8512", "10392", "10399", "10414", "10427", "10428", "10442", "10466", "10467", "10468", "10472", "10473", "10478", "10479", "10486", "10495", "10496", "10526", "10537", "10538", "10595", "10598", "10600", "10601", "10605", "10613", "10614", "10622", "10623", "10627", "15107", "15111", "15112", "16166", "16188", "16190", "16191", "16196", "16213", "17364", "20608", "21169", "25361", "25422", "25423", "25449", "25454", "25457", "25464", "25469", "25472", "25479", "25489", "25500", "25504", "25505", "25508", "25509", "25525", "25528", "25533", "25547", "25552", "25557", "25560", "25563", "25567", "25570", "25574", "25577", "25585", "25587", "25590"
];

// 데이터 파일 읽기
const dataPath = path.join(__dirname, '..', 'src', 'data', 'wowhead-full-descriptions-complete.json');
const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));

const originalCount = Object.keys(data).length;
const validSkillSet = new Set(validSkillIds);
const removedSkills = [];

// 구버전/쓸모없는 스킬 제거
const cleanedData = {};
Object.keys(data).forEach(skillId => {
  if (validSkillSet.has(skillId)) {
    // 유효한 스킬은 유지
    cleanedData[skillId] = data[skillId];
  } else {
    // 실제 Wowhead 설명이 없는 스킬 확인
    const skill = data[skillId];
    const hasGenericDescription = skill.description && (
      skill.description.includes('전투에서 사용하는 능력입니다') ||
      skill.description.includes('피해를 입힙니다') && skill.description.length < 30 ||
      skill.description.includes('회복시킵니다') && skill.description.length < 25
    );

    if (hasGenericDescription || !skill.krName) {
      // 구버전 스킬로 판단하여 제거
      removedSkills.push({
        id: skillId,
        name: skill.krName || skill.name || 'Unknown',
        description: skill.description
      });
    } else {
      // 유효해 보이는 스킬은 유지
      cleanedData[skillId] = data[skillId];
    }
  }
});

// 정리된 데이터 저장
fs.writeFileSync(dataPath, JSON.stringify(cleanedData, null, 2), 'utf8');

console.log('📊 스킬 데이터베이스 정리 완료!');
console.log(`🔢 원본 스킬 수: ${originalCount}개`);
console.log(`✅ 유지된 스킬 수: ${Object.keys(cleanedData).length}개`);
console.log(`❌ 제거된 구버전 스킬 수: ${removedSkills.length}개`);

if (removedSkills.length > 0) {
  console.log('\n📝 제거된 스킬 샘플 (처음 10개):');
  removedSkills.slice(0, 10).forEach(skill => {
    console.log(`  - ${skill.name} (${skill.id})`);
  });

  // 제거된 스킬 목록을 파일로 저장
  const removedPath = path.join(__dirname, 'removed-skills-log.json');
  fs.writeFileSync(removedPath, JSON.stringify(removedSkills, null, 2), 'utf8');
  console.log(`\n💾 제거된 스킬 전체 목록: ${removedPath}`);
}